1. Đặc tả chức năng cho các Next Steps
A. API Routes (user, analytics, transaction)
1. User API
GET /user/:address/nfts

Lấy danh sách NFT user sở hữu và trạng thái (đã cầm cố/chưa, vault status, giá trị ước tính, utility score).

GET /user/:address/loans

Danh sách các khoản vay đang active/inactive, health factor, LTV, lãi suất, trạng thái liquidation.

GET /user/:address/dpo

Thông tin về số lượng DPO token, lịch sử nhận/trade DPO token.

2. Analytics API
GET /analytics/collections

Tổng hợp dữ liệu về giá sàn, volatility, utility score, yield dự kiến của từng NFT collection hỗ trợ.

GET /analytics/loans

Tổng quan trạng thái sức khỏe các loan (số loan sắp bị thanh lý, tỷ lệ LTV trung bình, thống kê liquidation).

GET /analytics/yield

Lịch sử/biểu đồ lãi suất, yield, biến động theo thời gian của các pool/GameFi.

3. Transaction API
POST /tx/deposit

Nhận thông tin deposit NFT, trả về payload cho frontend gửi transaction (gồm ABI, contract, params).

POST /tx/borrow

Tạo giao dịch vay dựa trên NFT đã deposit (nhận params: NFT, amount).

POST /tx/repay

Tạo giao dịch trả nợ/giải chấp NFT.

POST /tx/withdraw

Tạo giao dịch rút NFT sau khi đã trả hết nợ.

POST /tx/dpo/transfer

Chuyển DPO token giữa user với các tham số.

B. Indexer Service (Sync Blockchain Data)
Theo dõi và quét block liên tục từ chainlet Saga RPC, index các event:

NFTDeposited, NFTWithdrawn

LoanCreated, LoanRepaid, LoanLiquidated

DPOTokensMinted, DPOTokensTraded, DPOTokensBurned

Ghi nhận và cập nhật DB:

Trạng thái NFT vault, loan, DPO token, lịch sử giao dịch.

Đảm bảo đồng bộ dữ liệu trong trường hợp server bị mất kết nối (reorg, retry).

Trigger thông báo realtime qua Socket.io khi có sự kiện liên quan user.

C. Authentication Middleware
Middleware xác thực bằng SIWE (Sign-In With Ethereum).

Validate chữ ký và nonce cho mỗi request cần auth (POST/tx/*, GET user data cá nhân…).

Trả lỗi 401 nếu chưa xác thực hoặc signature sai.

Lưu session/token xác thực ngắn hạn (JWT hoặc session memory).

D. Error Handling & Validation
Validate tham số đầu vào (address hợp lệ, số tiền, số token, chainID, v.v.).

Xử lý lỗi RPC, timeout, lỗi DB, lỗi contract revert.

Thống nhất trả về lỗi dạng JSON {error: "message", code: xxx}.

Log lỗi rõ ràng, support trace/debug, bảo mật không leak private key.

E. Testing & Deployment
Viết test cho từng API route (unit + integration).

Mock contract call/test event cho indexer.

Script migration, seed data cho PostgreSQL.

Dockerfile & scripts deploy server.

CI basic: lint, test, build.